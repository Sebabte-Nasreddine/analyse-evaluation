<!DOCTYPE html>
<html>

<head>
    <title>Test Upload Debug</title>
    <style>
        body {
            font-family: Arial;
            padding: 20px;
        }

        .box {
            border: 1px solid #ccc;
            padding: 15px;
            margin: 10px 0;
        }

        .success {
            background: #d4edda;
            border-color: #c3e6cb;
        }

        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        pre {
            background: #f5f5f5;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <h1>Test Upload - Diagnostic</h1>

    <div class="box">
        <h2>1. Test Backend Health</h2>
        <button onclick="testHealth()">Tester /health</button>
        <div id="health-result"></div>
    </div>

    <div class="box">
        <h2>2. Test Dashboard Stats</h2>
        <button onclick="testDashboard()">Tester /api/v1/dashboard/stats</button>
        <div id="dashboard-result"></div>
    </div>

    <div class="box">
        <h2>3. Test File Upload</h2>
        <input type="file" id="fileInput" accept=".csv">
        <button onclick="testUpload()">Upload File</button>
        <div id="upload-result"></div>
    </div>

    <script>
        async function testHealth() {
            const result = document.getElementById('health-result');
            result.innerHTML = '<p>Testing...</p>';

            try {
                const response = await fetch('http://localhost:8000/health');
                const data = await response.json();
                result.innerHTML = `
                    <div class="success">
                        <p>✓ Success! Status: ${response.status}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                result.innerHTML = `
                    <div class="error">
                        <p>✗ Error: ${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        }

        async function testDashboard() {
            const result = document.getElementById('dashboard-result');
            result.innerHTML = '<p>Testing...</p>';

            try {
                const response = await fetch('http://localhost:8000/api/v1/dashboard/stats');
                const data = await response.json();
                result.innerHTML = `
                    <div class="success">
                        <p>✓ Success! Status: ${response.status}</p>
                        <p>Total evaluations: ${data.total_evaluations}</p>
                        <pre>${JSON.stringify(data, null, 2).substring(0, 500)}...</pre>
                    </div>
                `;
            } catch (error) {
                result.innerHTML = `
                    <div class="error">
                        <p>✗ Error: ${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        }

        async function testUpload() {
            const result = document.getElementById('upload-result');
            const fileInput = document.getElementById('fileInput');

            if (!fileInput.files[0]) {
                result.innerHTML = '<div class="error"><p>Please select a file first!</p></div>';
                return;
            }

            result.innerHTML = '<p>Uploading...</p>';

            try {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);

                const response = await fetch('http://localhost:8000/api/v1/upload', {
                    method: 'POST',
                    body: formData,
                });

                const data = await response.json();

                if (response.ok) {
                    result.innerHTML = `
                        <div class="success">
                            <p>✓ Upload Success! Status: ${response.status}</p>
                            <p>Message: ${data.message}</p>
                            <p>File: ${data.file_name}</p>
                            <p>Evaluations processed: ${data.total_evaluations}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    result.innerHTML = `
                        <div class="error">
                            <p>✗ Server Error ${response.status}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                result.innerHTML = `
                    <div class="error">
                        <p>✗ Network Error: ${error.message}</p>
                        <p>Type: ${error.name}</p>
                        <p>This usually means:</p>
                        <ul>
                            <li>CORS is blocking the request</li>
                            <li>Backend is not accessible from browser</li>
                            <li>Request timed out</li>
                        </ul>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        }
    </script>
</body>

</html>